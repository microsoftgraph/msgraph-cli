# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

pool:
  name: Azure Pipelines
  vmImage: windows-latest

variables:
  - name: ProductBinPath
    value: '$(System.DefaultWorkingDirectory)\assets'
  - name: sourceRepository
    value: 'microsoftgraph/msgraph-cli'
  - name: repositoryConnection
    value: 'GitHub - calebkiage'
  - name: zipTemplate
    value: msgraph-cli-win-x64-{0}.zip
parameters:
  - name: tag
    displayName: Tag
    type: string
    default: latest


# download -> scan -> zip -> upload
#          -> sign
#

stages:
- stage: download
  jobs:
    - job: download
      steps:
      - checkout: none
      # Download GitHub Release
      # Downloads a GitHub Release from a repository
      - task: DownloadGitHubRelease@0
        inputs:
          connection: $(repositoryConnection)
          userRepository: $(sourceRepository)
          defaultVersionType: 'specificTag' # Options: latest, specificVersion, specificTag
          version: ${{ parameters.tag }} # Required when defaultVersionType != Latest
          itemPattern: '*-win-x64-*' # Optional
          downloadPath: '$(ProductBinPath)'
      - publish: $(ProductBinPath)
        artifact: assets
    - job: unzip
      dependsOn: download
      pool:
        vmImage: ubuntu-latest
      steps:
      - checkout: none
      - download: current
        artifact: assets
      - ${{ if startsWith(parameters.tag, 'v') }}:
        - script: echo "##vso[task.setvariable variable=cliVersion]$(echo ${{ parameters.tag }} | cut -c 2-)"
      - ${{ else }}:
        - script: echo "##vso[task.setvariable variable=cliVersion]${{ parameters.tag }}"
      - script: unzip "$(Pipeline.Workspace)/assets/$[format(variables['zipTemplate'], variables['cliVersion'])]" -d $(Pipeline.Workspace)/assets/unzipped
      - script: ls -a $(Pipeline.Workspace)/assets/*
      - publish: $(Pipeline.Workspace)/assets/unzipped
        artifact: unzipped


- stage: scan
  dependsOn: download
  jobs:
    - job: malware
      steps:
      - checkout: none
      - download: current
        artifact: unzipped
      - task: AntiMalware@3
        displayName: 'Run MpCmdRun.exe - ProductBinPath'
        inputs:
          FileDirPath: '$(Pipeline.Workspace)/unzipped'
        enabled: false
    
    - job: binSkim
      steps:
      - checkout: none
      - download: current
        artifact: unzipped
      - task: BinSkim@3
        displayName: 'Run BinSkim - Product Binaries'
        inputs:
          InputType: Basic
          AnalyzeTarget: '$(Pipeline.Workspace)\unzipped\mgc.exe'
          AnalyzeSymPath: '$(Pipeline.Workspace)\unzipped'
          AnalyzeVerbose: true
          AnalyzeHashes: true
          AnalyzeEnvironment: true

    - job: postAnalysis
      dependsOn: [malware, binSkim]
      steps:
      - checkout: none
      - task: PublishSecurityAnalysisLogs@2
        displayName: 'Publish Security Analysis Logs'
        inputs:
          ArtifactName: SecurityLogs

      - task: PostAnalysis@1
        displayName: 'Post Analysis'
        inputs:
          BinSkim: true
          CredScan: true
          PoliCheck: true

- stage: sign
  dependsOn: download
  jobs:
    - job: esrpSign
      steps:
      - checkout: none
      - download: current
        artifact: unzipped
      - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
        displayName: 'ESRP CodeSigning'
        inputs:
          ConnectedServiceName: 'microsoftgraph ESRP CodeSign DLL and NuGet (AKV)'
          FolderPath: '$(Pipeline.Workspace)\unzipped'
          signConfigType: inlineSignParams
          inlineOperation: |
            [
                {
                    "keyCode": "CP-230012",
                    "operationSetCode": "SigntoolSign",
                    "parameters": [
                    {
                        "parameterName": "OpusName",
                        "parameterValue": "Microsoft"
                    },
                    {
                        "parameterName": "OpusInfo",
                        "parameterValue": "http://www.microsoft.com"
                    },
                    {
                        "parameterName": "FileDigest",
                        "parameterValue": "/fd \"SHA256\""
                    },
                    {
                        "parameterName": "PageHash",
                        "parameterValue": "/NPH"
                    },
                    {
                        "parameterName": "TimeStamp",
                        "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                    }
                    ],
                    "toolName": "sign",
                    "toolVersion": "1.0"
                },
                {
                    "keyCode": "CP-230012",
                    "operationSetCode": "SigntoolVerify",
                    "parameters": [ ],
                    "toolName": "sign",
                    "toolVersion": "1.0"
                }
            ]
          SessionTimeout: 20
      - publish: $(Pipeline.Workspace)\unzipped
        artifact: msgraph-cli

- stage: zip
  dependsOn: [scan, sign]
  jobs:
    - job: zip
      pool:
        vmImage: ubuntu-latest
      steps:
      - checkout: none
      - download: current
        artifact: msgraph-cli
      - bash: |
          ls -a $(Pipeline.Workspace)/msgraph-cli | zip $[format(variables['zipTemplate'], variables['cliVersion'])]
      - publish: $(Pipeline.Workspace)/msgraph-cli/$[format(variables['zipTemplate'], variables['cliVersion'])]
        artifact: zipped

- stage: upload
  dependsOn: zip
  jobs:
    - job: upload
      steps:
      - checkout: none
      - download: current
        artifact: zipped
      - task: GithubRelease@1
        displayName: 'Edit GitHub Release'
        inputs:
          gitHubConnection: $(repositoryConnection)
          repositoryName: $(sourceRepository)
          action: edit
          isDraft: false
          tag: ${{ parameters.tag }}
          tagSource: 'manual'
          assets: $(Pipeline.Workspace)/zipped/**/$[format(variables['zipTemplate'], variables['cliVersion'])]
