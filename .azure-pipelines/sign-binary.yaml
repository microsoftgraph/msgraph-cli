# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

pool:
  name: Azure Pipelines
  vmImage: windows-latest

variables:
  - name: ProductBinPath
    value: '$(Build.SourcesDirectory)\bin\assets'
  - name: sourceRepository
    value: 'microsoftgraph/msgraph-cli'
  - name: repositoryConnection
    value: 'GitHub - calebkiage'
  - name: zipTemplate
    value: msgraph-cli-win-x64-{0}.zip
parameters:
  - name: tag
    displayName: Tag
    type: string
    default: latest


# download -> scan -> zip -> upload
#          -> sign
#

jobs:
  - job: download
    steps:
    - checkout: none
    # Download GitHub Release
    # Downloads a GitHub Release from a repository
    - task: DownloadGitHubRelease@0
      inputs:
        connection: $(repositoryConnection)
        userRepository: $(sourceRepository)
        defaultVersionType: 'specificTag' # Options: latest, specificVersion, specificTag
        version: ${{ parameters.tag }} # Required when defaultVersionType != Latest
        itemPattern: '*-win-x64-*' # Optional
        downloadPath: '$(ProductBinPath)'
  - job: unzip
    dependsOn: download
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: none
    - ${{ if startsWith(parameters.tag, 'v') }}:
      - script: echo "##vso[task.setvariable variable=cliVersion]$(echo ${{ parameters.tag }} | cut -c 1-)"
    - ${{ else }}:
      - script: echo "##vso[task.setvariable variable=cliVersion]${{ parameters.tag }}"
    - task: ExtractFiles@1
      inputs:
        destinationFolder: $(ProductBinPath)/msgraph-cli

  - job: malware
    dependsOn: unzip
    steps:
    - checkout: none
    - task: AntiMalware@3
      displayName: 'Run MpCmdRun.exe - ProductBinPath'
      inputs:
        FileDirPath: '$(ProductBinPath)\msgraph-cli'
      enabled: false
  
  - job: binSkim
    dependsOn: unzip
    steps:
    - checkout: none
    - task: BinSkim@3
      displayName: 'Run BinSkim - Product Binaries'
      inputs:
        InputType: Basic
        AnalyzeTarget: '$(ProductBinPath)\msgraph-cli\mgc.exe'
        AnalyzeSymPath: '$(ProductBinPath)'
        AnalyzeVerbose: true
        AnalyzeHashes: true
        AnalyzeEnvironment: true

  - job: postAnalysis
    dependsOn: [malware, binSkim]
    steps:
    - checkout: none
    - task: PublishSecurityAnalysisLogs@2
      displayName: 'Publish Security Analysis Logs'
      inputs:
        ArtifactName: SecurityLogs

    - task: PostAnalysis@1
      displayName: 'Post Analysis'
      inputs:
        BinSkim: true
        CredScan: true
        PoliCheck: true

  - job: esrpSign
    dependsOn: unzip
    steps:
    - checkout: none
    - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
      displayName: 'ESRP CodeSigning'
      inputs:
        ConnectedServiceName: 'microsoftgraph ESRP CodeSign DLL and NuGet (AKV)'
        FolderPath: $(ProductBinPath)\msgraph-cli
        signConfigType: inlineSignParams
        inlineOperation: |
          [
              {
                  "keyCode": "CP-230012",
                  "operationSetCode": "SigntoolSign",
                  "parameters": [
                  {
                      "parameterName": "OpusName",
                      "parameterValue": "Microsoft"
                  },
                  {
                      "parameterName": "OpusInfo",
                      "parameterValue": "http://www.microsoft.com"
                  },
                  {
                      "parameterName": "FileDigest",
                      "parameterValue": "/fd \"SHA256\""
                  },
                  {
                      "parameterName": "PageHash",
                      "parameterValue": "/NPH"
                  },
                  {
                      "parameterName": "TimeStamp",
                      "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                  }
                  ],
                  "toolName": "sign",
                  "toolVersion": "1.0"
              },
              {
                  "keyCode": "CP-230012",
                  "operationSetCode": "SigntoolVerify",
                  "parameters": [ ],
                  "toolName": "sign",
                  "toolVersion": "1.0"
              }
          ]
        SessionTimeout: 20

  - job: zip
    dependsOn: [esrpSign, postAnalysis]
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: none
    - bash: |
        ls -a $(ProductBinPath)/msgraph-cli | zip $[format(variables['zipTemplate'], variables['cliVersion'])]

  - job: upload
    dependsOn: zip
    steps:
    - checkout: none
    - task: GithubRelease@1
      displayName: 'Edit GitHub Release'
      inputs:
        gitHubConnection: $(repositoryConnection)
        repositoryName: $(sourceRepository)
        action: edit
        isDraft: false
        tag: ${{ parameters.tag }}
        tagSource: 'manual'
        assets: $(ProductBinPath)
