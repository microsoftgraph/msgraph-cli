name: Release CLI

trigger:
  branches:
    include:
      - refs/tags/v*

pool:
  name: Azure Pipelines
  vmImage: ubuntu-latest

variables:
  - name: sourceRepository
    value: 'microsoftgraph/msgraph-cli'
  - name: repositoryConnection
    value: 'GitHub - calebkiage'
  - name: zipTemplate
    value: msgraph-cli-{0}-{1}.zip
  - name: defaultTag
    value: ${{parameters.tag}}
  - name: buildPlatform
    value: 'Any CPU'
  - name: buildConfiguration
    value: 'Release'
  - name: outputDir
    value: $(Build.ArtifactStagingDirectory)/publish
  - name: internalFeed
    value: "Graph Developer Experiences/microsoft-graph-feed" # Format projectName/feedName

parameters:
  - name: tag
    displayName: Tag
    type: string
    default: latest

# test -> test -> build-{matrix} -> sign -> upload
#
stages:
  - stage: test
    displayName: Run tests
    jobs:
      - template: templates/compliance-checks.yaml
        parameters:
          scanSource: true

      - job: test
        displayName: Run tests
        dependsOn: []
        steps:
        - task: UseDotNet@2
          displayName: 'Use .NET 6'
          inputs:
            version: 6.x

        # Restore NuGet packages (enables cache by default)
        - template: templates/nuget-packages.yaml
          parameters:
            vstsFeedName: ${{variables.internalFeed}}

        # - task: DotNetCoreCLI@2
        #   displayName: Run tests
        #   inputs:
        #     command: test
        #     workingDirectory: $(Build.SourcesDirectory)
        #     arguments: --no-restore
  - stage: build
    displayName: Build CLI
    dependsOn: [test]
    jobs:
      - job: build
        displayName: Build and publish
        # variables:
        #   PACKAGE_VERSION: ${{github.event.inputs.tag || github.ref_name || 'v0.1.0'}}
        #   PACKAGE_ZIP_TEMPLATE: "msgraph-cli-{0}-{1}.zip"
        strategy:
          matrix:
            'Win x64':
              rid: win-x64
            'linux x64':
              rid: linux-x64
            'MacOS x64':
              rid: osx-x64
            'MacOS ARM':
              rid: osx-arm64
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET 6'
            inputs:
              version: 6.x

          - template: templates/nuget-packages.yaml
            parameters:
              extraRestoreArgs: --runtime $(rid)
              vstsFeedName: ${{variables.internalFeed}}

          # - task: DeleteFiles@1
          #   displayName: Delete any existing files in output dir
          #   inputs:
          #     SourceFolder: $(outputDir)
          #     Contents: "*"
          #     RemoveSourceFolder: false
          # - task: DotNetCoreCLI@2
          #   displayName: Publish package
          #   inputs:
          #     command: publish
          #     workingDirectory: $(Build.SourcesDirectory)
          #     arguments: '--no-restore --runtime $(rid) --self-contained true --configuration $(buildConfiguration) --output $(outputDir)-$(rid)'
          - pwsh: |
              Add-Content -Encoding utf8 -Path '$(outputDir)/$(rid)' -Value '$(rid)-$(Agent.OS)'
          
          - task: PublishPipelineArtifact@1
            inputs:
              artifact: build-output-$(rid)
              path: $(outputDir)-$(rid)
      - job: collect
        dependsOn: [build]
        steps:
          - task: DownloadPipelineArtifact@2
          - task: CopyFiles@2
            inputs:
              CleanTargetFolder: true
              SourceFolder: $(Pipeline.Workspace)
              Contents: "**/build-output-*/**"
              TargetFolder: $(outputDir)
              flattenFolders: false
          - pwsh: Get-ChildItem -Path '$(outputDir)'
          - publish: $(outputDir)
            artifact: build-output
  - stage: scan
    displayName: Scan binaries (Anti malware, BinSkim)
    dependsOn: [build]
    jobs:
    - template: templates/compliance-checks.yaml
      parameters:
        scanBinary: true
        buildOutputArtifact: build-output
  - stage: sign
    displayName: ESRP signing
    dependsOn: [build]
    jobs:
      - job: esrpSignWindows
        dependsOn: []
        displayName: ESRP Signing (Windows)
        strategy:
          matrix:
            'Windows':
              name: Windows
            'MacOS':
              name: MacOS
        steps:
          - download: current
            artifact: build-output
          - pwsh: |
              echo "TODO: Sign Windows binaries"
      - job: esrpSignOsx
        dependsOn: []
        displayName: ESRP Signing (MacOS)
        steps:
          - download: current
            artifact: build-output
          - pwsh: |
              echo "TODO: Sign MacOS binaries"
  - stage: upload
    dependsOn: [scan, sign]
    jobs:
      - job: upload
        displayName: Upload binaries
        steps:
          - pwsh: |
              echo "TODO: Upload"
    