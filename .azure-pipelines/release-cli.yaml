name: Release CLI

trigger:
  branches:
    include:
      - refs/tags/v*

pool:
  name: Azure Pipelines
  vmImage: ubuntu-latest

variables:
  - name: sourceRepository
    value: 'microsoftgraph/msgraph-cli'
  - name: repositoryConnection
    value: 'GitHub - calebkiage'
  - name: zipTemplate
    value: msgraph-cli-{0}-{1}.zip
  - name: defaultTag
    value: ${{parameters.tag}}
  - name: buildPlatform
    value: 'Any CPU'
  - name: buildConfiguration
    value: 'Release'
  - name: outputDir
    value: $(Build.ArtifactStagingDirectory)/publish
  - name: artifactsDownloadLocation
    value: $(Pipeline.Workspace)/artifacts
  - name: internalFeed
    value: "Graph Developer Experiences/microsoft-graph-packages" # Format projectName/feedName

parameters:
  - name: tag
    displayName: Tag
    type: string
    default: latest

#                   
# test -> build -> | sign |
#                  |------| -> upload
# srcScan -------> | scan |
stages:
  - stage: test
    displayName: Run tests
    dependsOn: []
    jobs:
      - job: test
        displayName: Run tests
        steps:
        - task: UseDotNet@2
          displayName: 'Use .NET 6'
          inputs:
            version: 6.x

        # Restore NuGet packages (enables cache by default)
        - template: templates/nuget-packages.yaml
          parameters:
            vstsFeedName: ${{variables.internalFeed}}

        - task: DotNetCoreCLI@2
          displayName: Run tests
          # TODO: Enable
          enabled: false
          inputs:
            command: test
            workingDirectory: $(Build.SourcesDirectory)
            arguments: --no-restore
  - stage: build
    displayName: Build CLI
    dependsOn: [test]
    jobs:
      - job: build
        displayName: Build and publish
        # variables:
        #   PACKAGE_VERSION: ${{github.event.inputs.tag || github.ref_name || 'v0.1.0'}}
        #   PACKAGE_ZIP_TEMPLATE: "msgraph-cli-{0}-{1}.zip"
        strategy:
          matrix:
            'Win x64':
              rid: win-x64
            'Linux x64':
              rid: linux-x64
            'MacOS x64':
              rid: osx-x64
            'MacOS ARM':
              rid: osx-arm64
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET 6'
            inputs:
              version: 6.x

          - template: templates/nuget-packages.yaml
            parameters:
              extraRestoreArgs: --runtime $(rid)
              vstsFeedName: ${{variables.internalFeed}}

          - task: DotNetCoreCLI@2
            displayName: Publish package
            # TODO: Enable
            enabled: false
            inputs:
              command: publish
              workingDirectory: $(Build.SourcesDirectory)
              arguments: '--no-restore --runtime $(rid) --self-contained true --configuration $(buildConfiguration) --output $(outputDir)-$(rid)'
          - pwsh: |
              New-Item '$(outputDir)-$(rid)' -ItemType Directory
              New-Item '$(outputDir)-$(rid)' -Name output.txt  -Value '$(rid) on $(Agent.OS) runner'
            # TODO: Disable
            enabled: true
          
          - task: PublishPipelineArtifact@1
            inputs:
              artifact: build-output-$(rid)
              path: $(outputDir)-$(rid)

  - stage: srcScan
    displayName: Scan source code
    pool:
      vmImage: windows-latest
    dependsOn: []
    jobs:
      - job: scan
        displayName: Scanning source
        steps:
          - template: templates/compliance-checks.yaml
            parameters:
              scanSource: true
  - stage: sign
    displayName: ESRP signing
    pool:
      vmImage: windows-latest
    dependsOn: [build]
    jobs:
      - job: esrpSignWindows
        dependsOn: []
        displayName: ESRP Signing (Windows)
        steps:
          - checkout: none
          - task: DownloadPipelineArtifact@2
            inputs:
              patterns: build-output-win*/**/*
              path: $(artifactsDownloadLocation)
          - pwsh: |
              Get-ChildItem $(artifactsDownloadLocation) -Recurse
              echo "TODO: Sign Windows binaries"
      - job: esrpSignMacOS
        dependsOn: []
        displayName: ESRP Signing (MacOS)
        steps:
          - checkout: none
          - task: DownloadPipelineArtifact@2
            inputs:
              patterns: build-output-osx*/**/*
              path: $(artifactsDownloadLocation)
          - pwsh: |
              Get-ChildItem $(artifactsDownloadLocation) -Recurse
              echo "TODO: Sign MacOS binaries"
  - stage: binaryScan
    displayName: Scan binaries (Anti malware, BinSkim)
    dependsOn: [build, srcScan]
    pool:
      vmImage: windows-latest
    jobs:
      - job: scan
        steps:
          - template: templates/compliance-checks.yaml
            parameters:
              artifactsDownloadLocation: $(artifactsDownloadLocation)
              scanBinary: true

  - stage: upload
    dependsOn: [binaryScan, sign]
    jobs:
      - job: upload
        displayName: Upload binaries
        steps:
          - checkout: none
          - pwsh: |
              echo "TODO: Upload"
    