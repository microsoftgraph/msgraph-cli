parameters:
  - name: 'useCache'
    type: boolean
    default: true
  - name: restorePath
    type: "string"
    default: $(Pipeline.Workspace)/.nuget/packages
  - name: extraRestoreArgs
    type: "string"
    default:

variables:
  - name: RESTORE_ARGS
    value: --use-lock-file --locked-mode ${{parameters.extraRestoreArgs}}

steps:
  - pwsh: |
      Write-Verbose "useCache = '${{parameters.useCache}}'"
      Write-Verbose "restorePath = '${{parameters.restorePath}}'"
      Write-Verbose "extraRestoreArgs = '${{parameters.extraRestoreArgs}}'"
      Write-Verbose "RESTORE_ARGS = '${{variables.RESTORE_ARGS}}'"

  - task: UseDotNet@2
    displayName: 'Use .NET 6'
    inputs:
      version: 6.x

  - ${{ if eq(parameters.useCache, true) }}:
    - task: Cache@2
      displayName: 'NuGet Cache'
      inputs:
        key: 'nuget | "$(Agent.OS)" | **/packages.lock.json,!**/bin/**,!**/obj/**'
        path: '${{parameters.restorePath}}'
        cacheHitVar: 'CACHE_RESTORED'
    - task: DotNetCoreCLI@2
      displayName: Restore packages
      condition: ne(variables.CACHE_RESTORED, true)
      inputs:
        command: restore
        workingDirectory: $(Build.SourcesDirectory)
        restoreArguments: ${{RESTORE_ARGS}}
        restoreDirectory: ${{parameters.restorePath}}
  - ${{ else }}:
    - task: DotNetCoreCLI@2
      displayName: Restore packages
      inputs:
        command: restore
        workingDirectory: $(Build.SourcesDirectory)
        noCache: true
        restoreArguments: $(RESTORE_ARGS)